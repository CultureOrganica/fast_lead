# Implementation Plan: Универсальный виджет и интеграция под любой сайт

## Смысл и цель задачи

Дать заказчикам простой способ подключить омниканальный appointment-setter через одну строку вставки на сайт. Увеличить конверсию заявок за счет мгновенного контакта в веб-чате и мессенджерах и быстрой записи на созвон. Результат: работающий MVP виджета с CDN, базовый бэкенд для событий lead_created, маршрутизация в инбокс и создание брони.

## Архитектура решения

### Виджет фронтенд

- widget.js, грузимый с CDN
- Рисует пульку, открывает мини-чат, собирает минимальные поля, отправляет события
- Конфиг через init-параметры: tenant, locale, channels, bookingUrl, optional flags
- Размещение: статические файлы на CDN

### Бэкенд шлюз

- Public API для приема lead_created и событий виджета
- Вебхуки приема готовых форм (autocapture) и обратных событий из инбокса и календаря
- Размещение: backend/api/public/

### Провайдеры коммуникаций

- SMS провайдер (Twilio, SMSC.ru или аналог)
- Email провайдер (SendGrid, AWS SES, Mailgun или аналог)
- Размещение: backend/channels/

### Оркестратор

- Шаги: квалификация лида, отправка сообщений в канал, ожидание ответа, генерация ссылки на бронь, эскалация оператору
- Размещение: backend/orchestrator/

### Инбокс

- Chatwoot как основной инбокс и веб-виджет
- Rocket.Chat как альтернатива
- Интеграция через API и вебхуки

### Календарь

- Cal.com для бронирования слотов и получения вебхуков
- Интеграция через API и вебхуки

### Хранилище

- Postgres для лидов, событий, согласий, каналов
- Redis для очередей, дедупликации, rate-limit
- Схема: backend/storage/migrations/

### Наблюдаемость

- Логи событий, базовые метрики, фича-флаг для включения/выключения
- Инструменты: встроенные логгеры, Prometheus-метрики

### Размещение компонентов

- Фронтенд-виджет: CDN (например, Cloudflare, AWS CloudFront)
- Бэкенд и оркестратор: существующая среда проекта
- Postgres и Redis: существующая инфраструктура

## Полный flow работы функционала

1. **Инициализация виджета**
   - Клиент вставляет сниппет на сайт
   - Виджет инициализируется параметрами арендатора (tenant, locale, channels)
   - Виджет загружается асинхронно, не блокируя загрузку страницы

2. **Сбор контактных данных**
   - Пользователь открывает виджет
   - Вводит имя, телефон и email (опционально в зависимости от выбранного канала)
   - Выбирает канал: web, WhatsApp, Telegram, SMS, Email, Instagram, MAX (для РФ)
   - При необходимости предоставляет согласие на обработку данных

3. **Создание лида**
   - Виджет отправляет lead_created в Public API с consent и UTM
   - При наличии - автоподхват submit/XHR существующей формы
   - API валидирует данные и создает запись лида

4. **Маршрутизация по каналу**
   - Оркестратор создает запись лида, валидирует телефон и email (в зависимости от канала)
   - Запускает сценарий канала:
     - **Web-чат**: сразу открывается диалог в виджете, предлагаются быстрые ответы и кнопка "Забронировать"
     - **Telegram**: открывается deeplink t.me/your_bot?start=token, бот продолжает опрос и выдает ссылку на бронь
     - **WhatsApp**: отправляется шаблонное приветствие при наличии валидного опт-ин, затем интерактив внутри окна
     - **SMS**: отправляется текстовое приветствие с ссылкой на бронирование, опционально короткая анкета через SMS
     - **Email**: отправляется email с приветствием, деталями услуги и кнопкой "Забронировать встречу", tracking открытий и кликов
     - **Instagram**: опционально для будущих версий, диалог через Instagram Direct API
     - **MAX**: РФ-ветка - запускается диалог через Bot API при инициации пользователем

5. **Бронирование слота**
   - Пользователь выбирает слот или переходит по bookingUrl
   - Cal.com подтверждает бронь и шлет вебхук в Public API
   - Оркестратор фиксирует бронь

6. **Финализация или эскалация**
   - Оркестратор закрывает задачу при успехе
   - Или поднимает разговор в инбокс оператору при неуспехе
   - Инбокс позволяет оператору перехватить любую беседу и продолжить в том же канале

7. **Аналитика**
   - Аналитика записывает time-to-first-contact, конверсию в слот и созвон
   - Метрики доступны через дашборд

## API и интерфейсы

### Public API

#### createLead

- **Назначение**: принять лид из виджета или автоподхвата формы
- **Параметры**: tenant, contact (name, phone, email), consent (gdpr, marketing), source, utm (source, medium, campaign), channel, payload
- **Возвращает**: leadId, рекомендации по следующему шагу (nextAction)
- **Ошибки**: 400 валидация, 409 дубль, 429 лимит

#### widgetEvents

- **Назначение**: телеметрия виджета (open, focus, submit, channel_select)
- **Параметры**: tenant, sessionId, eventName, data (произвольный payload)
- **Возвращает**: ok

### Webhooks

#### calendarBooked

- **Назначение**: получить подтверждение слота от Cal.com
- **Параметры**: bookingId, leadId, timeslot (start, end, timezone), attendees
- **Возвращает**: ok

#### inboxEvents

- **Назначение**: синхронить статусы диалога из Chatwoot/Rocket.Chat
- **Параметры**: conversationId, leadId, status (open, pending, resolved), assignee
- **Возвращает**: ok

### Orchestrator (внутренний API)

#### startQualification(leadId)

- **Назначение**: запустить процесс квалификации лида
- **Параметры**: leadId
- **Возвращает**: статус квалификации

#### dispatchToChannel(leadId, channel)

- **Назначение**: отправить лид в выбранный канал
- **Параметры**: leadId, channel
- **Возвращает**: статус отправки

#### escalateToInbox(leadId)

- **Назначение**: эскалировать лид оператору в инбокс
- **Параметры**: leadId
- **Возвращает**: conversationId

#### finalizeBooking(leadId, bookingId)

- **Назначение**: финализировать бронирование
- **Параметры**: leadId, bookingId
- **Возвращает**: статус финализации

## Взаимодействие компонентов

```
Widget -> Public API -> Orchestrator -> Channel connector -> Cal.com -> Public API -> Orchestrator -> Inbox
```

```
Existing site form -> Widget autocapture -> Public API -> Orchestrator
```

### Детальный flow

1. Widget инициирует событие (lead_created)
2. Public API принимает и валидирует данные
3. Orchestrator получает лид из очереди Redis
4. Orchestrator маршрутизирует в соответствующий Channel connector
5. Channel connector взаимодействует с внешним каналом (Telegram, WhatsApp и т.д.)
6. Cal.com принимает бронирование и отправляет вебхук
7. Public API принимает вебхук и обновляет статус
8. Orchestrator финализирует процесс или эскалирует в Inbox
9. Inbox (Chatwoot/Rocket.Chat) позволяет оператору перехватить диалог

## Порядок реализации

### Фаза 1: Базовый виджет и API

1. **Базовый вставляемый виджет**
   - Пулька, окно чата
   - Сбор минимальных полей (имя, телефон)
   - Отправка lead_created в Public API
   - Локализация и конфиг init

2. **Public API и модель лида**
   - Создание лида
   - Валидация входных данных
   - Согласия (GDPR, marketing)
   - Storage в Postgres
   - Метрики и логи

### Фаза 2: Интеграции

3. **Интеграция с Chatwoot**
   - Открытие диалога web-чат
   - Хэнд-офф оператору
   - Синхронизация статусов через вебхуки

4. **Интеграция Cal.com**
   - Прямая ссылка на слот
   - Прием вебхука подтверждения
   - Синхронизация данных бронирования

### Фаза 3: Автоподхват и каналы

5. **Автоподхват форм**
   - Слушатель submit/XHR на странице клиента
   - Отправка дубля в Public API
   - Дедупликация лидов

6. **Коннекторы каналов волной**
   - SMS: интеграция с провайдером (Twilio/SMSC.ru), отправка приветствия и ссылки
   - Email: интеграция с провайдером (SendGrid/AWS SES), шаблоны писем, tracking
   - Telegram: deeplink и первичные вопросы
   - WhatsApp: шаблон и интерактив в окне
   - MAX: для РФ-ветки (канал включается флагом)

### Фаза 4: Аналитика и UX

7. **Аналитика и фича-флаги**
   - Базовые алерты
   - Дашборд метрик
   - Feature flags для включения/выключения функций

8. **Плагины/инструкции CMS**
   - WordPress плагин и гайд
   - Инструкция для Shopify/Webflow/Wix

9. **Тюнинг UX**
   - Быстрые ответы
   - Кнопки "Забронировать"
   - Fallback на инбокс при проблемах

## Критичные граничные случаи

### Дубли лидов

- **Проблема**: один пользователь может отправить несколько форм подряд
- **Решение**: дедупликация с тайм-бакетом (например, 5 минут) по паре (tenant, phone)

### Отсутствие согласия для WhatsApp

- **Проблема**: нельзя отправлять шаблоны без согласия
- **Решение**: блокировать исходящие шаблоны, предлагать альтернативный канал (web-чат или Telegram)

### Недоступность Cal.com

- **Проблема**: сервис календаря может быть недоступен
- **Решение**: показывать альтернативу "Запросить обратный звонок", эскалация в инбокс

### 429/5xx от каналов

- **Проблема**: rate-limiting или временные ошибки API каналов
- **Решение**: ретраи с exponential backoff (3 попытки с задержкой 1s, 2s, 4s), идемпотентные ключи для предотвращения дублей

### Невалидные телефоны

- **Проблема**: пользователь может ввести некорректный номер
- **Решение**: валидация формата телефона на клиенте и сервере, уведомление пользователю об ошибке

### Переполнение очереди

- **Проблема**: слишком много событий в короткий промежуток времени
- **Решение**: rate-limiting по tenant, очередь с приоритетами, алерт при превышении порога

## Объем работ

### Что входит в реализацию

- Виджет (JavaScript, загружаемый с CDN)
- Public API (прием лидов и вебхуков)
- Оркестрация (маршрутизация, квалификация, эскалация)
- Коннектор Chatwoot (интеграция инбокса)
- Интеграция Cal.com (бронирование слотов)
- Автоподхват форм (перехват submit/XHR)
- Коннекторы каналов: SMS, Email, Telegram, WhatsApp, MAX (РФ)
- Фича-флаги (включение/выключение функций)
- Минимальная аналитика (метрики, логи)
- Инструкции CMS (WordPress, Shopify, Webflow, Wix)

## Что не входит

### Не реализуется в рамках MVP

- Полноценный CRM (только базовое хранение лидов)
- Сложная маршрутизация операторов и SLA (round-robin, skills-based routing)
- Глубокая персонализация UI виджета (темы, кастомные стили)
- Продвинутая антифрод логика (пока только базовая дедупликация)
- Массовые рассылки (broadcast campaigns)
- A/B тестирование виджета
- Интеграция с внешними CRM (Salesforce, HubSpot и т.д.)
- Голосовые звонки и видеочат
- Продвинутая аналитика (attribution, cohort analysis)
- Facebook Messenger и LinkedIn интеграции (можно добавить позже)
- Google Calendar и Calendly (используем только Cal.com в MVP)
- Интеграции через Zapier/Make (можно добавить позже через вебхуки)

## Допущения

### Ключевые допущения, влияющие на архитектуру

1. У арендатора есть юридически корректные тексты согласий (GDPR, marketing)
2. Канальные токены и номера получены и валидны (WhatsApp Business API, Telegram Bot Token)
3. SMS провайдер настроен (Twilio, SMSC.ru или аналог) с валидным API ключом и номером отправителя
4. Email провайдер настроен (SendGrid, AWS SES или аналог) с верифицированным доменом
5. Cal.com доступен и настроен с валидным API ключом
6. Существующая инфраструктура поддерживает Postgres и Redis
7. CDN настроен и доступен для хостинга статических файлов виджета
8. Клиенты готовы вставить сниппет виджета на свой сайт
9. Объем трафика в MVP не превысит 1000 лидов/час на tenant
10. Операторы инбокса обучены работе с Chatwoot

## Открытые вопросы

### Вопросы, требующие ответа заказчика или тимлида

1. Нужна ли синхронизация событий из внешней формы помимо автоподхвата (например, через Zapier/Make)?
2. Какие метрики считать критичными для первого релиза (time-to-first-contact, conversion rate, operator handoff rate)?
3. Базовая политика ретраев и лимитов по каналам (сколько попыток, какие интервалы)?
4. Требуется ли поддержка Instagram Direct в первой версии или можно отложить?
5. Нужен ли белый список доменов для CORS или достаточно разрешить все?
6. Требуется ли поддержка нескольких языков в первой версии виджета или достаточно одного?
7. Какой минимальный набор UTM-меток требуется отслеживать?
8. Какой SMS провайдер предпочтительнее (Twilio, SMSC.ru, другой)?
9. Какой Email провайдер предпочтительнее (SendGrid, AWS SES, Mailgun, другой)?

## Acceptance criteria

### Измеримые условия приемки для happy path

1. Виджет подключается одной строкой, открывается и собирает имя, телефон и email
2. Лид создается в системе и отдается в оркестратор
3. Web-чат доступен, диалог виден в инбоксе, возможен хэнд-офф оператору
4. Слот бронируется через Cal.com, подтверждение фиксируется у лида
5. SMS поток отправляет приветствие с ссылкой на бронирование
6. Email поток отправляет письмо с кнопкой бронирования, tracking открытий работает
7. Telegram поток работает через deeplink, бот отвечает и предлагает слот
8. WhatsApp поток отправляет шаблон только при наличии согласия
9. Все фичи выключаемы флагом без перезапуска сервиса
10. Автоподхват формы работает на тестовом сайте
11. При ошибке канала происходит fallback на web-чат
12. Логи содержат все ключевые события (open, submit, lead_created, booking_confirmed)

### Ручной сценарий проверки без автотестов

**Сценарий 1: Web-чат**
1. Открыть тестовый сайт с виджетом
2. Кликнуть на пульку виджета
3. Ввести имя и телефон
4. Выбрать канал "Web-чат"
5. Убедиться что диалог открылся
6. Кликнуть "Забронировать"
7. Выбрать слот в Cal.com
8. Убедиться что подтверждение пришло в инбокс

**Сценарий 2: SMS**
1. Ввести телефон, выбрать канал "SMS"
2. Проверить что SMS пришло на указанный номер
3. Перейти по ссылке из SMS
4. Забронировать слот

**Сценарий 3: Email**
1. Ввести email, выбрать канал "Email"
2. Проверить что письмо пришло
3. Убедиться что письмо содержит кнопку "Забронировать"
4. Кликнуть и забронировать слот

**Сценарий 4: Telegram и WhatsApp**
1. Повторить для Telegram (через deeplink)
2. Повторить для WhatsApp (проверить согласие)

## Definition of Done

1. Код и конфиги добавлены в репозиторий по структуре проекта
2. README фичи с инструкцией по установке и интеграции
3. Логи и базовые метрики включены
4. Фича зафлажена и может быть отключена без деплоя
5. Прошел code review
6. Ручное тестирование выполнено по сценарию выше
7. Документация по API опубликована (Swagger/OpenAPI)
8. Инструкции для CMS добавлены в docs/
9. Секреты вынесены в секрет-хранилище
10. Отсутствуют hardcoded значения в коде

## Минимальные NFR для MVP

### Производительность

- TTFB виджета с CDN до 150 мс (p95)
- Время до lead_created от submit до 1 с (p95)
- Public API обрабатывает запрос за 200 мс (p95)
- Оркестратор обрабатывает событие из очереди за 500 мс (p95)

### Надежность

- Не более 1% ошибок Public API на t0 (при запуске)
- 3 ретрая при 5xx от внешних сервисов
- SLA 99% для виджета (доступность с CDN)
- Очередь Redis выдерживает до 10000 заданий без деградации

### Ограничения

- Размер события (payload) до 64 КБ
- Очередь до 10000 заданий в Redis
- Rate-limit: 100 req/min на tenant для Public API
- Максимум 10 одновременных запросов на внешний сервис

## Требования безопасности

### Секреты

- Секреты только из секрет-хранилища проекта (AWS Secrets Manager, HashiCorp Vault и т.д.)
- Никаких токенов в коде или конфигах
- Ротация секретов каждые 90 дней

### PII

- PII не логировать в явном виде
- Маскирование телефонов в логах (показывать только последние 4 цифры)
- Шифрование PII в базе данных
- GDPR compliance: право на удаление и экспорт данных

### Сеть

- Исходящие запросы к каналам и Cal.com только к белому списку хостов
- HTTPS для всех внешних запросов
- CORS настроен только для доверенных доменов (или * для MVP с последующим ужесточением)
- Rate-limiting для защиты от DDoS

## Наблюдаемость

### Логи

Ключевые события и ошибки:

- виджет init (tenant, locale, channels)
- виджет open (sessionId, timestamp)
- виджет submit (leadId, channel, hasConsent)
- lead_created (leadId, tenant, channel, source)
- ошибки каналов (channel, error_type, leadId)
- booking_confirmed (leadId, bookingId, timeslot)
- escalation_to_inbox (leadId, conversationId, reason)

### Метрики

Минимум счетчики:

- Созданных лидов (по tenant, channel)
- Конверсия в бронь (leads_created / bookings_confirmed)
- Средний time-to-first-contact (от lead_created до первого ответа в канале)
- Ошибки по типам (validation_error, channel_error, booking_error)
- Rate-limit hits

### Трассировка

- Span от приема lead_created до события calendarBooked
- Tracing headers для корреляции запросов между сервисами
- Инструментация ключевых функций оркестратора

## Релиз

### Включение через feature flag

- Включение на стенде staging для внутреннего тестирования
- Затем на 10% клиентов (canary deployment)
- После прогрева и отсутствия ошибок - на всех

### План развертывания по окружениям

1. **Development**: непрерывный деплой из main ветки
2. **Staging**: деплой перед релизом, ручное тестирование
3. **Production canary**: 10% трафика
4. **Production full**: 100% трафика

### Деплой

- Сначала Public API и оркестратор (backward compatible)
- Затем публикация виджета на CDN
- Миграции базы данных запускаются перед деплоем бэкенда

## Откат

### Условия отката

- Более 5% ошибок Public API
- Более 10% ошибок каналов
- Жалобы клиентов на недоступность виджета
- Критическая уязвимость безопасности

### Шаги возврата состояния

1. Выключить фичу флагом (без деплоя)
2. Откатить версию виджета на предыдущий билд на CDN
3. Откатить бэкенд на предыдущую версию
4. Очистить отложенные задания оркестратора в Redis, чтобы избежать дублей
5. Проверить логи и метрики для диагностики проблемы
6. Исправить проблему и повторить релиз

## Риски и митигации

### Риск 1: Блокировка каналов из-за отсутствия согласия

- **Митигация**: строгая проверка consent до отправки в WhatsApp, fallback на web-чат при отсутствии согласия

### Риск 2: Деградация Cal.com

- **Митигация**: fallback "запрос звонка", эскалация в инбокс, мониторинг доступности Cal.com

### Риск 3: Рост RPS на Public API

- **Митигация**: rate-limit на уровне tenant, очереди в Redis для асинхронной обработки, горизонтальное масштабирование API

### Риск 4: Конфликт виджета с существующими скриптами на сайте клиента

- **Митигация**: изоляция виджета в shadow DOM, минимизация глобальных переменных, тестирование на популярных CMS

### Риск 5: GDPR нарушения при логировании PII

- **Митигация**: автоматическое маскирование PII в логах, регулярный аудит логов, обучение команды

### Риск 6: Недостаточная производительность Postgres при большом объеме лидов

- **Митигация**: индексы на часто запрашиваемые поля, партиционирование таблицы лидов по дате, read replicas

## Параметры стека

### Язык и версии

- Python 3.11+ для бэкенда
- JavaScript (ES6+) для виджета
- TypeScript для виджета (опционально, для лучшей типизации)

### Фреймворк

- Существующий в проекте веб-фреймворк (FastAPI, Flask, Django)
- Для виджета: vanilla JS или легкий фреймворк (Preact, Svelte)

### База данных и драйвер

- Postgres 14+
- Драйвер: psycopg2 или asyncpg
- Redis 6+ для очередей

### Целевая платформа деплоя

- Текущая платформа проекта (Docker, Kubernetes, AWS ECS и т.д.)
- CDN: Cloudflare, AWS CloudFront или аналог
- Секрет-хранилище: AWS Secrets Manager, HashiCorp Vault

## Самопроверка плана перед выдачей

- [x] Нет кода и псевдокода, выполнено
- [x] Заполнены scope, acceptance, risk, release
- [x] Регэксп именования файлов и задач выполняется
- [x] Нет упоминаний секретов и приватных URL
- [x] Использованы только стандартные символы дефисов и пробелов
- [x] Язык: русский
- [x] Все пути в POSIX-формате

## Проверки перед ломкой API

- [x] Подтверждено отсутствие внешних потребителей Public API (MVP, первый релиз)
- [x] Нет зависимых задач в текущем спринте
- [x] Можно менять структуру API без backward compatibility

## Профиль языка

- **primary_language**: python
- **stdlib_preferred**: true
- **note**: максимально использовать стандартную библиотеку Python, избегать лишних зависимостей
